name: Sync OpenAPI Spec

on:
  repository_dispatch:
    types: [openapi-updated]
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Generate token from GitHub App
        id: token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.WIZARD_APP_ID }}
          private-key: ${{ secrets.WIZARD_PRIVATE_KEY }}
          owner: invokation-games
          repositories: |
            ivk-skill
            kotlin-sdk

      - name: Download latest OpenAPI spec
        env:
          GH_TOKEN: ${{ steps.token.outputs.token }}
        run: |
          # Get latest api-v* release tag
          TAG=$(gh release list --repo invokation-games/ivk-skill --json tagName \
            | jq -r '[.[] | select(.tagName | startswith("api-v"))][0].tagName')

          echo "Latest API release: $TAG"

          # Download the asset and rename to expected filename
          gh release download "$TAG" --repo invokation-games/ivk-skill --pattern "openapi.json"
          mv openapi.json ivk-skill-openapi.json

      - name: Check for changes
        id: diff
        run: |
          if git diff --quiet ivk-skill-openapi.json; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Generate SDK
        if: steps.diff.outputs.changed == 'true'
        run: |
          npx @openapitools/openapi-generator-cli generate \
            -c openapi-generator-config.yaml \
            -i ivk-skill-openapi.json \
            -g kotlin \
            -o skill-sdk \
            --enable-post-process-file

      - name: Create Pull Request
        if: steps.diff.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ steps.token.outputs.token }}
          commit-message: "chore: sync openapi spec"
          title: "chore: sync openapi spec"
          body: |
            Automated sync of OpenAPI specification from latest api release.
          branch: chore/sync-openapi
          committer: the-release-wizard[bot] <the-release-wizard[bot]@users.noreply.github.com>
          author: the-release-wizard[bot] <the-release-wizard[bot]@users.noreply.github.com>
          delete-branch: true
